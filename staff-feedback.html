<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C&E's Cafe – Feedback Viewer</title>

<style>
body { margin:0; font-family:Arial,sans-serif; background:#eef4fc; }
header {
  background:#3f7fbf;
  color:white;
  text-align:center;
  padding:16px;
}

header button {
  margin-top:10px;
  padding:8px 14px;
  background:white;
  color:#3f7fbf;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-weight:bold;
}

main {
  max-width:800px;
  margin:auto;
  padding:20px;
}

.stats {
  background:white;
  padding:16px;
  border-radius:8px;
  margin-bottom:20px;
  text-align:center;
}

.feedback {
  background:white;
  padding:14px;
  border-radius:6px;
  margin-bottom:12px;
  position: relative;
}

.stars { color:#f5b301; font-size:18px; }
.time { font-size:12px; color:#666; }
.ip { font-size:12px; color:#999; margin-top:4px; }
.deleteBtn {
  position: absolute;
  top:12px;
  right:12px;
  background:#ff5c5c;
  color:white;
  border:none;
  border-radius:4px;
  padding:4px 8px;
  cursor:pointer;
  font-size:12px;
}
.deleteBtn:hover { background:#ff2c2c; }
</style>
</head>

<body>

<header>
  <h1>Customer Feedback ⭐</h1>
  <button onclick="window.location.href='staff.html'">⬅ Back to Orders</button>
</header>

<main>

  <div class="stats">
    <h2>Average Rating: <span id="average">—</span> ⭐</h2>
    <p id="count">No feedback yet</p>
  </div>

  <div id="feedbackList"></div>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyAIugKjWMFbB8eDLSY5JInBM1lsyQ3bIHo",
  authDomain: "drink-order-test.firebaseapp.com",
  databaseURL: "https://drink-order-test-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "drink-order-test",
  storageBucket: "drink-order-test.firebaseappdestorage.app",
  messagingSenderId: "90936648282",
  appId: "1:90936648282:web:b9854c3438319db80cae63"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const feedbackRef = ref(db, "reviews"); // <-- match the refined feedback page

const list = document.getElementById("feedbackList");
const avgEl = document.getElementById("average");
const countEl = document.getElementById("count");

let totalStars = 0;
let totalCount = 0;

function stars(r) {
  return "★".repeat(r) + "☆".repeat(5 - r);
}

onChildAdded(feedbackRef, snap => {
  const f = snap.val();
  if (!f || typeof f.rating !== "number") return;

  totalStars += f.rating;
  totalCount++;

  avgEl.textContent = (totalStars / totalCount).toFixed(1);
  countEl.textContent = `${totalCount} review${totalCount > 1 ? "s" : ""}`;

  const div = document.createElement("div");
  div.className = "feedback";

  div.innerHTML = `
    <strong>${f.name || "Anonymous"}</strong>
    <div class="stars">${stars(f.rating)}</div>
    <div>${f.comment || "<em>No comment</em>"}</div>
    <div class="ip">IP: ${f.ip || "Unknown"}</div>
    <div class="time">${new Date(f.timestamp).toLocaleString()}</div>
    <button class="deleteBtn">Delete</button>
  `;

  // Delete button functionality
  const deleteBtn = div.querySelector(".deleteBtn");
  deleteBtn.addEventListener("click", () => {
    if(confirm("Are you sure you want to delete this feedback?")) {
      remove(ref(db, `reviews/${snap.key}`)).then(() => {
        div.remove();
        totalStars -= f.rating;
        totalCount--;
        avgEl.textContent = totalCount ? (totalStars / totalCount).toFixed(1) : "—";
        countEl.textContent = totalCount ? `${totalCount} review${totalCount > 1 ? "s" : ""}` : "No feedback yet";
      });
    }
  });

  list.prepend(div);
});
</script>

</body>
</html>
