<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C&E's Cafe - Staff Orders</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background:#eef4fc;
    margin:0;
  }

  header {
    background:#3f7fbf;
    color:white;
    text-align:center;
    padding:15px;
  }

  header button {
    margin:5px;
  }

  main {
    padding:20px;
    max-width:800px;
    margin:auto;
  }

  .order {
    border:1px solid #ccc;
    padding:12px;
    margin-bottom:12px;
    border-radius:6px;
    position:relative;
  }

  /* ORDER STATES */
  .new-order { background:#ffe6e6; }        /* red */
  .acknowledged { background:#fff3cd; }     /* yellow */
  .fulfilled-order { background:#e6f4ea; }  /* green */

  .fulfilled-check {
    position:absolute;
    top:10px;
    right:10px;
    font-size:22px;
    color:green;
  }

  button {
    padding:6px 12px;
    background:#3f7fbf;
    color:white;
    border:none;
    cursor:pointer;
    border-radius:4px;
  }

  button:hover {
    background:#2e5f9e;
  }

  .clear-btn {
    background:#c0392b;
  }

  .clear-btn:hover {
    background:#a93226;
  }

  /* NEW ORDER OVERLAY */
  #newOrderBanner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #c0392b;
    color: white;
    font-size: 22px;
    font-weight: bold;
    text-align: center;
    padding: 16px;
    z-index: 9999;
    display: none;
    animation: pulse 1.2s infinite;
  }

  @keyframes pulse {
    0% { background:#c0392b; }
    50% { background:#e74c3c; }
    100% { background:#c0392b; }
  }

  /* Flash effect on new orders */
  .flash {
    animation: flashBg 1s ease-in-out 3;
  }

  @keyframes flashBg {
    0% { background:#ffe6e6; }
    50% { background:#ffb3b3; }
    100% { background:#ffe6e6; }
  }

</style>
</head>

<body>

<header>
  <h1>C&E's Cafe - Staff Orders</h1>
  <button id="enableSound">Enable Notifications üîî</button>
  <button id="clearFulfilled" class="clear-btn">Clear Fulfilled Orders üóëÔ∏è</button>
</header>

<main>
  <div id="orders"></div>
</main>

<audio id="bellSound" src="bell.mp3" preload="auto"></audio>

<!-- NEW ORDER BANNER -->
<div id="newOrderBanner">üîî NEW ORDER RECEIVED</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase,
  ref,
  onChildAdded,
  onChildChanged,
  update,
  remove
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyAIugKjWMFbB8eDLSY5JInBM1lsyQ3bIHo",
  authDomain: "drink-order-test.firebaseapp.com",
  databaseURL: "https://drink-order-test-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "drink-order-test",
  storageBucket: "drink-order-test.firebasedestorage.app",
  messagingSenderId: "90936648282",
  appId: "1:90936648282:web:b9854c3438319db80cae63"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ordersRef = ref(db, "orders");

const ordersDiv = document.getElementById("orders");
const bell = document.getElementById("bellSound");

let soundEnabled = false;
let bellInterval = null;
const banner = document.getElementById("newOrderBanner");

/* Enable sound (required once) */
document.getElementById("enableSound").addEventListener("click", () => {
  bell.play().then(() => {
    bell.pause();
    bell.currentTime = 0;
    soundEnabled = true;
    alert("Notifications enabled!");
  });
});

/* Bell control */
function startBell() {
  if (!soundEnabled || bellInterval) return;
  bellInterval = setInterval(() => {
    bell.currentTime = 0;
    bell.play().catch(()=>{});
  }, 15000);
}

function stopBell() {
  clearInterval(bellInterval);
  bellInterval = null;
}

/* Show NEW ORDER banner */
function showBanner() {
  banner.style.display = "block";
}

/* Hide NEW ORDER banner */
function hideBanner() {
  banner.style.display = "none";
}

/* Vibration (Android supported) */
function vibrateAlert() {
  if (navigator.vibrate) {
    navigator.vibrate([300, 200, 300, 200, 500]);
  }
}

/* New order */
onChildAdded(ordersRef, snapshot => {
  const order = snapshot.val();
  const key = snapshot.key;

  const orderDiv = document.createElement("div");
  orderDiv.id = key;
  orderDiv.className = "order new-order";

  orderDiv.innerHTML = `
    <strong>Customer:</strong> ${order.customerName}<br>
    <strong>Drink:</strong> ${order.drink}<br>
    <strong>Temperature:</strong> ${order.temperature}<br>
    <strong>Milk:</strong> ${order.milk}<br>
    <strong>Sweetener:</strong> ${order.sweetener}<br>
    <strong>Time:</strong> ${order.timestamp}<br>

    <button class="ackBtn">I'll make that now! üõ†Ô∏è</button>
    <button class="fulfillBtn">Delivered to customer ‚úÖ</button>
  `;

  ordersDiv.prepend(orderDiv);
  startBell();
  showBanner();
  vibrateAlert();
  orderDiv.classList.add("flash");

  orderDiv.querySelector(".ackBtn").onclick = () => {
    update(ref(db, `orders/${key}`), { acknowledged: true });
    hideBanner();
  };

  orderDiv.querySelector(".fulfillBtn").onclick = () => {
    update(ref(db, `orders/${key}`), { fulfilled: true });
  };
});

/* Order state updates */
onChildChanged(ordersRef, snapshot => {
  const order = snapshot.val();
  const key = snapshot.key;
  const orderDiv = document.getElementById(key);
  if (!orderDiv) return;

  if (order.acknowledged && !order.fulfilled) {
    orderDiv.className = "order acknowledged";
    stopBell();
  }

  if (order.fulfilled) {
    orderDiv.className = "order fulfilled-order";
    orderDiv.querySelectorAll("button").forEach(b => b.remove());

    const check = document.createElement("span");
    check.className = "fulfilled-check";
    check.textContent = "‚úÖ";
    orderDiv.appendChild(check);
  }
});

/* Clear fulfilled orders only */
document.getElementById("clearFulfilled").addEventListener("click", () => {
  if (!confirm("Clear all fulfilled orders?")) return;

  document.querySelectorAll(".fulfilled-order").forEach(div => {
    remove(ref(db, `orders/${div.id}`));
    div.remove();
  });
});

/* Clear ALL orders */
document.getElementById("clearAllOrders").addEventListener("click", () => {
  if (!confirm("WARNING: This will DELETE ALL ORDERS in the system. Proceed?")) return;

  document.querySelectorAll(".order").forEach(div => {
    remove(ref(db, `orders/${div.id}`));
    div.remove();
  });
});
</script>

</body>
</html>
