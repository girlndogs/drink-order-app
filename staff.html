<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C&E's Cafe - Staff Orders</title>
<style>
body { font-family: Arial, sans-serif; background:#eef4fc; margin:0; }
header { background:#3f7fbf; color:white; text-align:center; padding:15px; position:sticky; top:0; z-index:1000; }
header button { margin:5px; }
main { padding:20px; max-width:900px; margin:auto; }
.order { border:1px solid #ccc; padding:12px; margin-bottom:12px; border-radius:6px; position:relative; }
.new-order { background:#ffe6e6; }
.acknowledged { background:#fff3cd; }
.fulfilled-order { background:#e6f4ea; }
.fulfilled-check { position:absolute; top:10px; right:10px; font-size:22px; color:green; }
button { padding:6px 12px; background:#3f7fbf; color:white; border:none; cursor:pointer; border-radius:4px; }
button:hover { background:#2e5f9e; }
.clear-btn { background:#c0392b; }
.clear-btn:hover { background:#a93226; }
.deliver-btn { position:absolute; bottom:10px; right:10px; }
.feedback-btn, .blocked-btn { position:fixed; bottom:20px; left:20px; background:#f39c12; }
.feedback-btn { left:20px; }
.blocked-btn { left:180px; background:#e74c3c; }
.feedback-btn:hover { background:#d68910; }
.blocked-btn:hover { background:#c0392b; }
.stats { margin:10px 0; font-weight:bold; }
</style>
</head>
<body>

<header>
  <h1>C&E's Cafe - Staff Orders</h1>
  <button id="enableSound">Enable Notifications üîî</button>
  <button id="clearFulfilled" class="clear-btn">Clear Fulfilled Orders üóëÔ∏è</button>
  <button id="clearAll" class="clear-btn">‚ö†Ô∏è Clear All Orders</button>
  <div class="stats">
    Total Drinks Made (last 24h): <span id="drinksMade">0</span> |
    Avg Prep Time: <span id="avgTime">0</span> mins
  </div>
</header>

<main>
  <div id="orders"></div>
</main>

<!-- Footer buttons -->
<button id="viewFeedback" class="feedback-btn">View Feedback üìù</button>
<button id="viewBlocked" class="blocked-btn">View Blocked IPs üö´</button>

<audio id="bellSound" src="bell.mp3" preload="auto"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase, ref, onChildAdded, onChildChanged, update, remove, query, orderByChild, get
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAIugKjWMFbB8eDLSY5JInBM1lsyQ3bIHo",
  authDomain: "drink-order-test.firebaseapp.com",
  databaseURL: "https://drink-order-test-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "drink-order-test",
  storageBucket: "drink-order-test.firebaseappdestorage.app",
  messagingSenderId: "90936648282",
  appId: "1:90936648282:web:b9854c3438319db80cae63"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ordersRef = ref(db, "orders");

const ordersDiv = document.getElementById("orders");
const bell = document.getElementById("bellSound");

let soundEnabled = false;
let bellInterval = null;
const spokenOrders = new Set();

// Enable notifications
document.getElementById("enableSound").addEventListener("click", () => {
  bell.play().then(()=>{ bell.pause(); bell.currentTime=0; soundEnabled=true; alert("Notifications enabled!"); });
});

// Navigate to feedback viewer
document.getElementById("viewFeedback").addEventListener("click", () => {
  window.location.href = "staff-feedback.html"; // corrected URL
});

// Navigate to blocked IP page (placeholder)
document.getElementById("viewBlocked").addEventListener("click", () => {
  window.location.href = "blocked_ips.html"; // new page to be created
});

// Bell function (only rings for unacknowledged orders)
function startBell() {
  if (!soundEnabled || bellInterval) return;
  const unacknowledged = Array.from(document.querySelectorAll(".order.new-order, .order.acknowledged")).length;
  if(unacknowledged === 0) return;

  bell.currentTime = 0; bell.play().catch(()=>{});
  bellInterval = setInterval(() => {
    const unack = Array.from(document.querySelectorAll(".order.new-order, .order.acknowledged")).length;
    if(unack === 0) { stopBell(); return; }
    bell.currentTime = 0; bell.play().catch(()=>{});
  }, 30000);
}

function stopBell() { clearInterval(bellInterval); bellInterval = null; }

// Speak order (female, warmer voice)
function speakNewOrder(name) {
  if (!soundEnabled || !window.speechSynthesis) return;
  if (spokenOrders.has(name)) return;
  spokenOrders.add(name);

  const msg = new SpeechSynthesisUtterance(`Hey! A new order for ${name} has arrived.`);
  const voices = window.speechSynthesis.getVoices();
  msg.voice = voices.find(v => v.name.toLowerCase().includes("female") || v.name.toLowerCase().includes("zira")) || voices[0];
  msg.pitch = 1.2;
  msg.rate = 1.0;
  window.speechSynthesis.speak(msg);
}

// Add order to DOM
function addOrder(order,key) {
  const orderDiv=document.createElement("div");
  orderDiv.id=key;
  orderDiv.className="order new-order";

  const orderTime = order.timestamp ? new Date(order.timestamp) : new Date();

  orderDiv.innerHTML = `
    <strong>Customer:</strong> ${order.customerName}<br>
    <strong>IP:</strong> ${order.ip || 'N/A'}<br>
    <strong>Drink:</strong> ${order.drink}<br>
    <strong>Temp:</strong> ${order.temperature}<br>
    <strong>Milk:</strong> ${order.milk}<br>
    <strong>Sweetener:</strong> ${order.sweetener}<br>
    <strong>Ordered At:</strong> ${orderTime.toLocaleString()}<br>
    <button class="ackBtn">I'll make that now! üõéÔ∏è</button>
    <button class="blockBtn">Block IP</button>
    <button class="fulfillBtn deliver-btn">Delivered ‚úÖ</button>
  `;

  ordersDiv.prepend(orderDiv);
  startBell();
  speakNewOrder(order.customerName);

  // Button events
  orderDiv.querySelector(".ackBtn").onclick = ()=>update(ref(db,`orders/${key}`),{acknowledged:true});
  orderDiv.querySelector(".fulfillBtn").onclick = async ()=> {
    const deliveredAt = new Date().toISOString();
    await update(ref(db,`orders/${key}`),{fulfilled:true, deliveredAt});
    updateStats(); 
  };
  orderDiv.querySelector(".blockBtn").onclick = ()=>{
    if(confirm(`Block IP ${order.ip}?`)) {
      update(ref(db,`blockedIPs/${order.ip}`),{blocked:true, timestamp:new Date().toISOString()});
      alert(`IP ${order.ip} blocked.`);
    }
  };
}

// Listen for orders
onChildAdded(ordersRef, snap=>addOrder(snap.val(),snap.key));
onChildChanged(ordersRef,snap=>{
  const order=snap.val();
  const div=document.getElementById(snap.key);
  if(!div) return;

  if(order.acknowledged && !order.fulfilled) div.className="order acknowledged";
  if(order.fulfilled) {
    div.className="order fulfilled-order";
    div.querySelectorAll("button").forEach(b=>b.remove());
    const check=document.createElement("span");
    check.className="fulfilled-check"; check.textContent="‚úÖ";
    div.appendChild(check);
  }
  startBell(); 
});

// Clear fulfilled
document.getElementById("clearFulfilled").addEventListener("click",()=>{
  if(!confirm("Clear all fulfilled orders?")) return;
  document.querySelectorAll(".fulfilled-order").forEach(div=>{
    remove(ref(db,`orders/${div.id}`));
    div.remove();
  });
  updateStats();
});

// Clear all
document.getElementById("clearAll").addEventListener("click",()=>{
  if(!confirm("‚ö†Ô∏è THIS WILL DELETE ALL ORDERS! Are you sure?")) return;
  document.querySelectorAll(".order").forEach(div=>{
    remove(ref(db,`orders/${div.id}`));
    div.remove();
  });
  updateStats();
});

// Stats calculation
async function updateStats() {
  const now = Date.now();
  const dayAgo = now - 24*60*60*1000;
  const snapshot = await get(ref(db,"orders"));
  let count=0, totalTime=0, fulfilledCount=0;

  snapshot.forEach(child=>{
    const o = child.val();
    if(o.fulfilled && new Date(o.deliveredAt).getTime() > dayAgo){
      count++;
      const start = new Date(o.timestamp).getTime();
      const end = new Date(o.deliveredAt).getTime();
      totalTime += (end-start)/60000; 
      fulfilledCount++;
    }
  });

  document.getElementById("drinksMade").textContent = count;
  document.getElementById("avgTime").textContent = fulfilledCount ? (totalTime/fulfilledCount).toFixed(1) : '0';
}

// Refresh stats every 5 seconds
setInterval(updateStats,5000);
updateStats();

</script>
</body>
</html>
