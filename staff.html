<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>C&E's Cafe Staff</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onChildAdded, remove } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getMessaging, getToken, onMessage } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

    // ðŸ”¹ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAIugKjWMFbB8eDLSY5JInBM1lsyQ3bIHo",
      authDomain: "drink-order-test.firebaseapp.com",
      databaseURL: "https://drink-order-test-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "drink-order-test",
      storageBucket: "drink-order-test.firebasestorage.app",
      messagingSenderId: "90936648282",
      appId: "1:90936648282:web:b9854c3438319db80cae63"
};

    // ðŸ”¹ Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messaging = getMessaging(app);

    // ðŸ”¹ Ask permission for notifications
    Notification.requestPermission().then(permission => {
      if (permission === "granted") {
        getToken(messaging, { vapidKey: "BLDw10RXk8HbYhJsvV6hMYhuDsxMSxSXaAgZ8W0PiU_nakxoVfBeRta0T-nuzLbj3ieLJjSk2ZXUSHNtv8vdBio" })
          .then(async (token) => {
            console.log("FCM TOKEN:", token);

            // ðŸ”¹ Subscribe device to "staff" topic via Firebase REST API
            await fetch(
              `https://iid.googleapis.com/iid/v1/${token}/rel/topics/staff`,
              {
                method: "POST",
                headers: {
                  Authorization: "key=684405ef0d259d5e2442e65919738262414eaf9f"
                }
              }
            );
            console.log("Subscribed to topic: staff");
          });
      }
    });

    // ðŸ”¹ Handle notifications while app is open
    onMessage(messaging, payload => {
      console.log("Foreground notification received:", payload);

      // Play bell sound
      const audio = new Audio("bell.mp3");
      audio.play().catch(err => console.log("Audio blocked:", err));

      // Show popup
      const popup = document.getElementById("popup");
      popup.textContent = `${payload.notification.title} - ${payload.notification.body}`;
      popup.style.display = "block";
      setTimeout(() => { popup.style.display = "none"; }, 5000);
    });

    // ðŸ”¹ Database reference
    const ordersRef = ref(db, "orders");

    // Display incoming orders in staff page
    const ordersDiv = document.getElementById("orders");
    onChildAdded(ordersRef, (snapshot) => {
      const order = snapshot.val();
      const orderEl = document.createElement("div");
      orderEl.textContent = `${order.customerName} ordered ${order.drink} (${order.temperature})`;
      ordersDiv.prepend(orderEl);
    });

    // ðŸ”¹ Clear orders
    function clearOrders() {
      if (confirm("Are you sure you want to clear the order history?")) {
        remove(ordersRef);
        ordersDiv.innerHTML = "";
      }
    }
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #eef3fb;
      margin: 0;
      padding: 0;
    }
    header {
      background: url('https://images2.imgbox.com/8a/e2/3ncKiPGu_o.jpg') no-repeat center/cover;
      height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2em;
      font-weight: bold;
      text-shadow: 1px 1px 3px #000;
    }
    main {
      padding: 20px;
    }
    #orders div {
      padding: 10px;
      margin: 5px 0;
      background-color: #cce5ff;
      border-radius: 5px;
    }
    #popup {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #ffeb3b;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 5px #333;
      display: none;
      z-index: 1000;
    }
    button {
      background: #007bff;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      margin-top: 10px;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>

<body>
  <header>C&E's Cafe Staff</header>
  <main>
    <div id="popup"></div>
    <h2>Incoming Orders</h2>
    <div id="orders"></div>
    <button onclick="clearOrders()">Clear Order History</button>
  </main>
</body>
</html>
